<!DOCTYPE html> 

<html>
<head>
    <title>TypeScript Web harness</title>
    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.9.1.js"></script>
    <script src='perfCompiler.js'></script>
    <script>
        var repeat = 1;
        var batch;

        if (!batch) {
            batch = new BatchCompiler();
        }

        function appendTime(message, time) {
            var res = message + ": " + time;
            var div = document.createElement('div');
            div.innerText = res;
            document.body.appendChild(div);
        }

        function clear1() {
            $("div").remove();
        }

        function run(f) {
            var start = new Date().getTime();
            for (var i = 0; i < repeat; i++) {
                f();

                // If we're repeating multiple times, then ignore the first run so we don't count 
                // the time taken to JIT.
                if (repeat > 1 && i === 0) {
                    start = new Date().getTime();
                }
            }

            var end = new Date().getTime();
            if (repeat > 1) {
                appendTime("Average", (end - start) / (repeat - 1));
            }
        }

        var currentCompilerSourcesTree;
        var currentLibDTSTree;

        function parseCompilerSources() {
            run(function () {
                var start = new Date().getTime();

                currentCompilerSourcesTree = batch.parseCompilerSources();

                var end = new Date().getTime();
                appendTime("Time: ", end - start);
            });
        }

        function parseLibDTS() {
            run(function () {
                var start = new Date().getTime();

                currentLibDTSTree = batch.parseLibDTSSource();

                var end = new Date().getTime();
                appendTime("Time: ", end - start);
            });
        }

        function incrementalParseLibDTS() {
            if (!currentLibDTSTree) {
                currentLibDTSTree = batch.parseLibDTSSource();
            }

            run(function () {
                var start = new Date().getTime();
                currentLibDTSTree = batch.incrementalParseLibDTSSource(currentLibDTSTree);
                var end = new Date().getTime();
                appendTime("Time: ", end - start);
            });
        }

        function fullCompile() {
            var start = new Date().getTime();
            compile();
            var end = new Date().getTime();
            appendTime("Time: ", end - start);
        }

    </script>
</head>
<body>
    <h1>TypeScript Perf Testbed</h1>
    <button onclick="parseCompilerSources()">Parse Compiler Sources</button>
    <button onclick="parseLibDTS()">Parse lib.d.ts</button>
    <button onclick="incrementalParseLibDTS()">Incremental Parse lib.d.ts</button>
    <button onclick="fullCompile()">Compile</button>
    <button onclick="clear1()">Clear</button>
</body>
</html>
